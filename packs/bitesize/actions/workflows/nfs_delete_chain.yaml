---
  chain:
    -
      name: "nfs_spec"
      ref: "bitesize.nfs_spec"
      params:
        payload: "{{payload}}"
      on-success: "get_pvs"
    -
      name: "get_pvs"
      ref: "consul.get"
      parameters:
        key: "nfs/{{nfs_spec.result.customer}}/pvs/"
        recurse: True
      on-success: "pv_count"
    -
      name: "pv_count"
      ref: "core.local"
      parametres:
        cmd: "[[ ! -z {{get_pvs.result[0].Value}} ]]"
      on-success: "delete_persistent_volumes"
      on-failure: "delete_cloudformation_stack"
    -
      name: "delete_persistent_volumes"
      ref: "kubernetes.deleteCoreV1PersistentVolume"
      params:
        body: "{}"
        name: "{{get_pvs.result[0].Value}}"
      on-success: "delete_pv_from_consul"
    -
      name: "delete_pv_from_consul"
      ref: "consul.delete"
      params:
        key: "nfs/{{nfs_spec.result.customer}}/pvs/{{get_pvs.result[0].Value}}"
      on-success: "get_pvs"
      on-failure: "get_pvs"
    -
      name: "delete_cloudformation_stack"
      ref: "aws.cf_delete_stack"
      params:
        stack_name_or_id: "{{nfs_spec.result.stack_name_or_id}}"
      on-success: "delete_consul_data"
    -
      name: "delete_consul_data"
      ref: "consul.delete"
      parameters:
        key: "nfs/{{nfs_spec.result.customer}}/"
        recurse: True
