---
  chain:
    -
      name: "nfs_spec"
      ref: "bitesize.nfs_spec"
      parameters:
        payload: "{{payload}}"
      on-success: "get_all_pvs"
    -
      name: "get_all_pvs"
      ref: "consul.get"
      parameters:
        key: "nfs/{{nfs_spec.result.customer}}/pvs/"
        recurse: True
      on-success: "get_pv"
    -
      name: "get_pv"
      ref: "consul.get"
      parameters:
        key: "nfs/{{nfs_spec.result.customer}}/pvs/get_pvs.result[0].Value"
        recurse: False
      on-success: "delete_persistent_volumes"
      on-failure: "delete_cloudformation_stack"
    -
      name: "delete_persistent_volumes"
      ref: "kubernetes.deleteCoreV1PersistentVolume"
      parameters:
        body: "{}"
        name: "{{get_pv.result.Value}}"
      on-success: "delete_pv_from_consul"
    -
      name: "delete_pv_from_consul"
      ref: "consul.delete"
      parameters:
        key: "nfs/{{nfs_spec.result.customer}}/pvs/{{get_pv.result.Value}}"
      on-success: "get_all_pvs"
    -
      name: "delete_cloudformation_stack"
      ref: "aws.cf_delete_stack"
      parameters:
        stack_name_or_id: "{{nfs_spec.result.stack_name_or_id}}"
      on-success: "delete_consul_data"
    -
      name: "delete_consul_data"
      ref: "consul.delete"
      parameters:
        key: "nfs/{{nfs_spec.result.customer}}/"
        recurse: True
