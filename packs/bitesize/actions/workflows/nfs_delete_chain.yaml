version: '2.0'
bitesize.nfs_delete_chain:
  description: Cleanup NFS and PVS when NFS TPR is removed
  type: direct
  input:
    - payload
  tasks:
    nfs_spec:
      action: bitesize.nfs_spec
      input:
        payload: <% $.payload %>
      publish:
        customer: <% task(nfs_spec).result.result.customer %>
        stack: <% task(nfs_spec).result.result.stack_name_or_id %>
      on-success: get_pvs
    get_pvs:
      action: consul.get
      input:
        key: nfs/<% $.customer %>/pvs/
        recurse: True
      publish:
        pv: <% task(get_pvs).result.result.Value %>
      on-success: delete_persistent_volume
      on-error: delete_cloudformation_stack  #Error will happen when no PVs exist and pv publish in this task fails to occur. No more PVs, tear down the stack
    delete_persistent_volume:
      action: kubernetes.deleteCoreV1PersistentVolume
      input:
        body: {}
        name: <% $.pv[0] %>
      on-success: delete_pv_from_consul
    delete_pv_from_consul:
      action: consul.delete
      input:
        key: nfs/<% $.customer %>/pvs/<% $.pv[0] %>
      on-success: get_pvs
    delete_cloudformation_stack:
      action: aws.cf_delete_stack
      input:
        stack_name_or_id: <% $.stack %>
      on-success: delete_consul_data
    delete_consul_data:
      action: consul.delete
      input:
        key: nfs/<% $.customer %>/
        recurse: True
